version: '3.8'

services:
  # PostgreSQL database with pgvector extension
  postgres:
    image: pgvector/pgvector:pg16
    container_name: blogmon-postgres
    environment:
      POSTGRES_DB: blogmon
      POSTGRES_USER: blogmon
      POSTGRES_PASSWORD: blogmon_secure_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U blogmon -d blogmon"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - blogmon-network

  # Technical Blog Monitor daemon
  blog-monitor:
    build:
      context: .
      dockerfile: Containerfile
    container_name: blogmon-daemon
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Application settings
      ENVIRONMENT: production
      DEBUG: "false"

      # Database configuration (unified PostgreSQL storage)
      VECTOR_DB__DB_TYPE: pgvector
      VECTOR_DB__CONNECTION_STRING: postgresql://blogmon:blogmon_secure_password@postgres:5432/blogmon
      CACHE__BACKEND: postgres
      CACHE__POSTGRES_DSN: postgresql://blogmon:blogmon_secure_password@postgres:5432/blogmon

      # Embedding configuration
      EMBEDDING__TEXT_MODEL_TYPE: sentence_transformers
      EMBEDDING__TEXT_MODEL_NAME: all-MiniLM-L6-v2
      EMBEDDING__USE_GPU: "false"

      # Feed configuration
      FEEDS__0__NAME: AWS Blog
      FEEDS__0__URL: https://aws.amazon.com/blogs/aws/feed/
      FEEDS__0__CHECK_INTERVAL_MINUTES: "60"
      FEEDS__0__MAX_POSTS_PER_CHECK: "10"
      FEEDS__0__ENABLED: "true"

      FEEDS__1__NAME: Azure Blog
      FEEDS__1__URL: https://azure.microsoft.com/en-us/blog/feed/
      FEEDS__1__CHECK_INTERVAL_MINUTES: "60"
      FEEDS__1__MAX_POSTS_PER_CHECK: "10"
      FEEDS__1__ENABLED: "true"

      FEEDS__2__NAME: GitHub Blog
      FEEDS__2__URL: https://github.blog/feed
      FEEDS__2__CHECK_INTERVAL_MINUTES: "60"
      FEEDS__2__MAX_POSTS_PER_CHECK: "10"
      FEEDS__2__ENABLED: "true"

      # Browser configuration
      BROWSER__MAX_CONCURRENT_BROWSERS: "2"
      BROWSER__TIMEOUT_SECONDS: "30"
      BROWSER__HEADLESS: "true"
      BROWSER__BLOCK_ADS: "true"

      # Article processing
      ARTICLE_PROCESSING__FULL_CONTENT_CAPTURE: "true"
      ARTICLE_PROCESSING__CONCURRENT_ARTICLE_TASKS: "2"
      ARTICLE_PROCESSING__MAX_ARTICLES_PER_FEED: "20"
      ARTICLE_PROCESSING__ARCHIVE_HTML: "true"
      ARTICLE_PROCESSING__ARCHIVE_SCREENSHOTS: "false"

      # Logging
      METRICS__LOG_LEVEL: INFO
      METRICS__STRUCTURED_LOGGING: "true"

    volumes:
      - ./data:/app/data
      - ./cache:/app/cache
    ports:
      - "8080:8080"  # Web dashboard (if enabled)
    networks:
      - blogmon-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "from monitor.config import load_settings; load_settings()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  postgres_data:
    driver: local

networks:
  blogmon-network:
    driver: bridge
